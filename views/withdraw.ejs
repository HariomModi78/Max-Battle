<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/stylesheets/wallet.css">
    <link rel="stylesheet" href="/stylesheets/withdraw.css">
    <link rel="stylesheet" href="/stylesheets/boiler.css">
    <link rel="stylesheet" href="/stylesheets/header.css">
    <link rel="stylesheet" href="/stylesheets/footer.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#007bff">
</head>
<body>
    <main>
        <div class="disconnect">
            <img src="/images/disconnect.webp" alt="">
        </div>
        <div class="header">
            <div class="logo back" id="wallet">
                <img loading="lazy" style="height: 2rem;width: 2rem;" id="home" src="https://cdn-icons-png.flaticon.com/128/3114/3114883.png" alt="">
            </div>
            
            <div class="greet">
                <p class="big">Withdraw Coins</p>
            </div>
            <div class="notification">
                <!-- <img loading="lazy" src="https://cdn-icons-png.flaticon.com/128/2311/2311524.png" alt=""> -->
            </div>
        </div>
        <div class="fakeHeader" id="/withdraw/<%=user._id%>"></div>
        
        <div class="page">
            
            <div class="part1">
            <div class="amount">
                <img loading="lazy" class="smallCoin" src="https://cdn-icons-png.flaticon.com/128/9382/9382295.png" alt="">
                <%=user.totalBalance.toLocaleString("en-IN")%></div>
            <div class="options">
                <div class="option1">
                    <div class="optionAmount1">
                        <img loading="lazy" class="verySmallCoin" src="https://cdn-icons-png.flaticon.com/128/9382/9382295.png" alt="">
                        <%=user.deposited.toLocaleString("en-IN")%></div>
                    <div class="optionName1">Deposited</div>
                </div>
                <div class="option1">
                    <div class="optionAmount1">
                        <img loading="lazy" class="verySmallCoin" src="https://cdn-icons-png.flaticon.com/128/9382/9382295.png" alt="">
                        <%=user.winning.toLocaleString("en-IN")%></div>
                    <div class="optionName1">Winning</div>
                </div>
                <div class="option1">
                    <div class="optionAmount1">
                        <img loading="lazy" class="verySmallCoin" src="https://cdn-icons-png.flaticon.com/128/9382/9382295.png" alt="">
                        <%=user.bonus.toLocaleString("en-IN")%></div>
                    <div class="optionName1">Bonus</div>
                </div>
            </div>
            
        </div>

        <form method="post">
            <%if(user.upi.length>0){%>
                <div class="upiCover">
                <input class="input" type="radio" checked required>
                <label for=""></label>
                <p><%=user.upi[0]%></p>
                <img src="/images/upi.png" alt="">
                </div>       
            
                <input class="input" style="border-bottom:0.5px solid gray;border-radius: 0 ;" type="number" name="amount" id="amount" placeholder="Amount" required>
                
            <input class="normalButton" id="input" type="submit" value="Withdraw">
            <div class="bind" style="display: none;"></div>
             </form>
            <%}else{%>
                <br>
                <div class="bind" id="<%=user._id%>">
                    <img src="https://cdn-icons-png.flaticon.com/128/992/992482.png" alt="">
                    <p>Add your UPI</p>
                    <p>Get ₹1 Instant</p>
                    <p>after this you unable to add new upi</p>
                </div>
                <div class="dummy" style="display: none;">
            <div class="inputBox">
                <input class="input" type="number"  id="amount" placeholder="" required>
                <label for="amount">Amount</label>
            </div>
            <input class="normalButton" id="input" type="submit" value="Withdraw">
        </div>

            <%}%>
            <div class="inputBox hidden">
                <input  class="input" type="text" name="upiId" id="upiId1" placeholder="UPI id" required>
            </div>
            <br>
            <div class="confirm hidden blue" >Confirm</div>
       <div class="alert"></div>
        <strong id="<%=user.winning%>">
            Note:You can only withdraw winning maxcoins
            <div class="note">(Minimum withdrawal amount: ₹3)</div>
            <div class="note">3% transaction fee</div>
        </strong>
        
    </main>
    <script>
       
        let bind = document.querySelector(".bind");
        let hidden = document.getElementsByClassName("hidden");
        let upi1 = document.querySelector("#upiId1");
        bind.addEventListener("click",function(){
            bind.style.display = "none"
            for(let i=0;i<hidden.length;i++){
                if(i==0){
                hidden[i].style.display = "block"
                }else{
                hidden[i].style.display = "flex"

                }
            }
        })
        upi1.addEventListener("input",function(){
            if(upi1.value.trim().length>0){
                hidden[1].classList.add("colorBlue");
            }else{
                hidden[1].classList.remove("colorBlue");
            }
        })
        hidden[1].addEventListener("click",function(){
            if(upi1.value.trim().length>0){
                let success = "https://cdn-icons-png.flaticon.com/128/16208/16208195.png"
                let wait = "https://cdn-icons-png.flaticon.com/128/11524/11524253.png"; 
                let fail = "https://cdn-icons-png.flaticon.com/128/399/399274.png";
                let image = document.createElement("img");
                image.src = wait;
                hidden[1].innerHTML = "";
                image.classList.add("rotate");
                hidden[1].appendChild(image); 
                let res = fetch(`/userUpi/${bind.id}`,{
                    method:"POST",
                    headers:{
                        "Content-Type":"application/json"
                    },
                    body:JSON.stringify({upi:upi1.value})
                })
                .then(async (response) => {
    const result = await response.json();

    // Show success or fail image
    if (result === true) {
        image.src = success;
    } else {
        image.src = fail;
    }
    image.classList.remove("rotate");
    hidden[1].innerHTML = "";
    hidden[1].appendChild(image);
    setTimeout(function(){
        window.location.reload();
    },1000)
})
.catch((error) => {
    console.error("Error sending UPI:", error);
    image.src = fail;
    hidden[1].innerHTML = "";
    hidden[1].appendChild(image);
});
                
            }else{
                console.log("invalid upi")
            }
        })
        
        let fakeHeader = document.querySelector(".fakeHeader");
        let form1 = document.querySelector("form");
        let strong = document.querySelector("strong");
        let amount = document.querySelector("#amount");
        let button = document.querySelector("#input");
        let alertText = document.querySelector(".alert");
        amount.addEventListener("input",function(){
            if(amount.value.trim().length>0){
                button.classList.add("color");
            }else{
                button.classList.remove("color");
            }
        })
        button.addEventListener("click",function(e){
            
            if((amount.value).length>0){
                if(parseInt(amount.value)<3){
                    e.preventDefault();
                    alertText.innerHTML = "minimum withdraw is ₹3";
                }else{ 
                if(parseFloat(strong.id)<parseFloat(amount.value)){
                    e.preventDefault();
                    alertText.innerHTML = "You don't have sufficent balance";
                }else{
                    button.style.display = "none";
                    alertText.style.cssText = "color:green";
                    alertText.innerHTML = "Processing..."
                    form1.action = fakeHeader.id;
                }
            }
            }
        })
        window.addEventListener("pageshow",()=>{
                amount.value = "";
                button.style.display = "flex";
                alertText.innerHTML = ""
        })
    </script>
    <script src="/javaScripts/back.js"></script>
    <script src="/javaScripts/boiler.js"></script>
    <script type="module" src="/script.js"></script>

</body>
</html>